<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Spring-JPA by thirunar</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">Spring-JPA</h1>
      <h2 class="project-tagline"></h2>
      <a href="https://github.com/thirunar/spring-jpa" class="btn">View on GitHub</a>
      <a href="https://github.com/thirunar/spring-jpa/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/thirunar/spring-jpa/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <h3>
<a id="integration-spring-with-jpa" class="anchor" href="#integration-spring-with-jpa" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Integration Spring with JPA</h3>

<p>The Spring Framework is an application framework and inversion of control container for the Java platform. The framework's core features can be used by any Java application, but there are extensions for building web applications on top of the Java EE platform. </p>

<p>The Java Persistence API (JPA) is a Java application programming interface specification that describes the management of relational data in applications using Java Platform, Standard Edition and Java Platform, Enterprise Edition.</p>

<p>This project will explain you about integrating the Spring framework with JPA. As a part of this, it will also explain the use of Liquibase libraries for creating the tables in the database. Liquibase is an open source database-independent library for tracking, managing and applying database schema changes.</p>

<h3>
<a id="how-to-run-the-project" class="anchor" href="#how-to-run-the-project" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>How to run the project</h3>

<p><code>mvn spring-boot:run</code></p>

<h3>
<a id="intializing-the-spring-project" class="anchor" href="#intializing-the-spring-project" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Intializing the Spring project</h3>

<p>Use the <a href="https://start.spring.io/">link</a> to bootstrap your spring application. </p>

<h3>
<a id="adding-the-dependencies" class="anchor" href="#adding-the-dependencies" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Adding the dependencies</h3>

<p>Following are the dependencies which are needed for the project. Please add the dependencies in the pom.xml</p>

<p>`</p>

<pre><code>    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-data-jpa&lt;/artifactId&gt;
    &lt;/dependency&gt;

    &lt;dependency&gt;
        &lt;groupId&gt;org.postgresql&lt;/groupId&gt;
        &lt;artifactId&gt;postgresql&lt;/artifactId&gt;
        &lt;version&gt;${postgresql.version}&lt;/version&gt;
    &lt;/dependency&gt;

    &lt;dependency&gt;
        &lt;groupId&gt;org.liquibase&lt;/groupId&gt;
        &lt;artifactId&gt;liquibase-core&lt;/artifactId&gt;
        &lt;version&gt;${liquibase.version}&lt;/version&gt;
    &lt;/dependency&gt;

    &lt;dependency&gt;
        &lt;groupId&gt;org.apache.commons&lt;/groupId&gt;
        &lt;artifactId&gt;commons-lang3&lt;/artifactId&gt;
        &lt;version&gt;3.4&lt;/version&gt;
    &lt;/dependency&gt;

    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
    &lt;/dependency&gt;
</code></pre>

<p>`
This project uses postgresql as the database so adding the dependency for it. </p>

<h3>
<a id="setup-liquibase" class="anchor" href="#setup-liquibase" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Setup Liquibase</h3>

<p>I going consider the College and department relationship for the demonstration. I will be having two tables named <code>college, department</code>. The college table will have the following fields</p>

<ul>
<li>id</li>
<li>name</li>
</ul>

<p>The department table will have the following fields:</p>

<ul>
<li>id</li>
<li>name</li>
<li>college_id
<code>college_id</code> is the foreign key which references the <code>id</code> column in the college table.</li>
</ul>

<p>With this assumption, the first step in setting up liquibase is creating a database called <code>college</code> in postgres DB. This can be done using the command: <code>createdb college</code></p>

<p>The following properties has to be added in application.properties</p>

<p>`
    spring.datasource.url=jdbc:postgresql://localhost:5432/college
    spring.datasource.username=postgres
    spring.datasource.password=postgres
    liquibase.change-log=classpath:liquibase/changesets.xml</p>

<p>`</p>

<p>Create a file called <code>changesets.xml</code> under <code>resources/liquibase</code> and add the following lines:</p>

<p>`</p>

<pre><code>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.3.xsd"&gt;

    &lt;changeSet id="201603050433" author="Thiru"&gt;
        &lt;createTable tableName="COLLEGE"&gt;
            &lt;column name="ID" type="BIGINT" autoIncrement="true"&gt;
                &lt;constraints primaryKey="true" nullable="false"/&gt;
            &lt;/column&gt;
            &lt;column name="NAME" type="varchar(255)"/&gt;
        &lt;/createTable&gt;

        &lt;createTable tableName="DEPARTMENT"&gt;
            &lt;column name="ID" type="BIGINT" autoIncrement="true"&gt;
                &lt;constraints primaryKey="true" nullable="false"/&gt;
            &lt;/column&gt;
            &lt;column name="NAME" type="varchar(255)"/&gt;
            &lt;column name="COLLEGE_ID" type="BIGINT"/&gt;
        &lt;/createTable&gt;
        &lt;addForeignKeyConstraint baseTableName="DEPARTMENT" baseColumnNames="COLLEGE_ID"
                                 constraintName="DEPARTMENT_COLLEGE_ID_FK"
                                 referencedTableName="COLLEGE"
                                 referencedColumnNames="ID"/&gt;

    &lt;/changeSet&gt;

&lt;/databaseChangeLog&gt;
</code></pre>

<p>`</p>

<p>Run <code>mvn clean install</code> to add these tables to the database.</p>

<h3>
<a id="creating-the-domain-models" class="anchor" href="#creating-the-domain-models" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Creating the domain models</h3>

<p>Create two class called College and Department and add the corresponding field variable. </p>

<p>College Class:</p>

<p>`</p>

<pre><code>@Entity
@Table(name = "COLLEGE")
public class College {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private long id;

    @Column(name = "name")
    private String name;

    @OneToMany(mappedBy = "college", fetch = FetchType.EAGER, cascade = CascadeType.PERSIST)
    private List&lt;Department&gt; departments;

    public College() {
    }

    public College(int id) {
        this.id = id;
    }

    public College(String name, List&lt;Department&gt; departments) {
        this.name = name;
        this.departments = departments;
    }


    public long getId() {
        return id;
    }

    public String getName() {
        return name;
    }

    @Override
    public boolean equals(Object o) {
        return new EqualsBuilder().reflectionEquals(this, o);
    }

    @Override
    public int hashCode() {
        return new HashCodeBuilder(17, 37).reflectionHashCode(this);
    }

    public List&lt;Department&gt; getDepartments() {
        return departments;
    }
}
</code></pre>

<p>`</p>

<p>Note that, this class is annotated with <code>Entity and Table</code> and maps to the <code>college</code> table. College will have many departments in it. So, there is a one to many mapping for the list of departments fields. <code>@GeneratedValue</code> will help you in auto increment the <code>id</code> field.</p>

<p>Department Class:</p>

<p>`</p>

<pre><code>@Entity
@Table(name = "DEPARTMENT")
public class Department {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private long id;

    @Column(name = "NAME")
    private String name;

    @ManyToOne
    @JoinColumn(name = "COLLEGE_ID", referencedColumnName = "ID")
    private College college;

    public Department() {
    }

    public Department(String name) {
        this.name = name;
    }

    public long getId() {
        return id;
    }

    public String getName() {
        return name;
    }

    @Override
    public boolean equals(Object o) {
        return new EqualsBuilder().reflectionEquals(this, o);
    }

    @Override
    public int hashCode() {
        return new HashCodeBuilder(17, 37).reflectionHashCode(this);
    }

}
</code></pre>

<p>`</p>

<p>Since, a <code>department</code> will belong to a college, there is many to one mapping for the field <code>college</code>. The field is also annotated with <code>JoinColumn</code> for specifying based on which join has to done.</p>

<h3>
<a id="adding-and-retrieving-data-to-the-database" class="anchor" href="#adding-and-retrieving-data-to-the-database" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Adding and retrieving data to the database</h3>

<p>A controller called <code>CollegeController</code> has been creating for serving the purpose. This basically calls the service and the service in turn calls the <code>CollegeRepository</code> where the logic of adding and retrieving the data resides. The controller basically exposes <code>GET</code> and <code>POST</code> APIs.</p>

<p>CollegeController.java:
`</p>

<pre><code>@Controller
@RequestMapping("/college")
public class CollegeController {

    @Autowired
    private CollegeService collegeService;

    @ResponseBody
    @RequestMapping(method = RequestMethod.GET, produces = "application/json")
    public College getCollege(@RequestParam long id) {
        return collegeService.getCollege(id);
    }

    @ResponseBody
    @RequestMapping(method = RequestMethod.POST, produces = "text/plain", consumes = "application/json")
    public String save(@RequestBody College college) {
        collegeService.save(college);
        return "Successfully saved";
    }
}
</code></pre>

<p>`</p>

<p>The <code>getCollege</code> method used to get the college and its department based on the College id. The <code>save</code> posts the data to the database. </p>

<h3>
<a id="repository-layer" class="anchor" href="#repository-layer" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Repository Layer</h3>

<p>This layer interacts with the database and helps in adding and retrieving the data from the database. The class called <code>CollegeRespository</code> solves this purpose. This uses <code>EntityManager</code> for saving and fetcing the data.</p>

<p>`</p>

<pre><code>@Repository
public class CollegeRepository {

    @PersistenceContext
    private EntityManager entityManager;

    @Autowired
    private EntityManagerFactory entityManagerFactory;

    @Transactional
    public void save(College college) {
        entityManager.persist(college);
    }

    public College getCollege(long id) {
        return entityManager.find(College.class, id);
    }

    public List&lt;Department&gt; getDepartmentsForTheCollege(long id) {
        College college = getCollege(id);
        return college.getDepartments();
    }
}
</code></pre>

<p><code>
The class is annotated with</code>Repository<code>. The</code>save<code>method is made</code>Transactional<code>. The</code>getCollege` method fetches the college with its departments and returns the data.</p>

<h3>
<a id="references" class="anchor" href="#references" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>References:</h3>

<ul>
<li><a href="http://www.baeldung.com/liquibase-refactor-schema-of-java-app">http://www.baeldung.com/liquibase-refactor-schema-of-java-app</a></li>
<li><a href="https://en.wikipedia.org/wiki/Java_Persistence_API">https://en.wikipedia.org/wiki/Java_Persistence_API</a></li>
</ul>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/thirunar/spring-jpa">Spring-JPA</a> is maintained by <a href="https://github.com/thirunar">thirunar</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

            <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-74760810-1");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>

  </body>
</html>
